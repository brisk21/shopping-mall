<!DOCTYPE html>
<html lang="zh">
<head>
<title>商品列表</title>
<{include file="public/header" /}>

  <style>
    #list{
      overflow: auto;
      height: 700px;
    }
  </style>
</head>
<body ontouchstart>
<!--顶部搜索-->
<header class='weui-header fixed-top'>
  <div class="weui-search-bar" id="searchBar">
    <form class="weui-search-bar__form">
      <div class="weui-search-bar__box">
        <i class="weui-icon-search"></i>
        <input type="search" value="" name="keyword" class="weui-search-bar__input" id="searchInput" placeholder="搜索您想要的商品" required>
        <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
      </div>
      <label class="weui-search-bar__label" id="searchText" style="transform-origin: 0px 0px 0px; opacity: 1; transform: scale(1, 1);">
        <i class="weui-icon-search"></i>
        <span>搜索您想要的商品</span>
      </label>
    </form>
    <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
  </div>
  <div class="pro-sort">
    <div class="weui-flex">
      <div class="weui-flex__item"><div class="placeholder NormalCss sort-item" onclick="setSort('normal',this)">综合</div></div>
      <div class="weui-flex__item"><div class="placeholder  sort-item" onclick="setSort('sale',this)">按销量</div></div>
      <div class="weui-flex__item"><div class="placeholder  sort-item" onclick="setSort('price',this)">按价格</div></div>
    </div>
  </div>
</header>
<!--主体-->
<div class="weui-content" style="padding-top:85px;">
  <!--产品列表--滑动加载-->
  <div class="weui-pull-to-refresh__layer">
    <div class='weui-pull-to-refresh__arrow'></div>
    <div class='weui-pull-to-refresh__preloader'></div>
    <div class="down">下拉刷新</div>
    <div class="up">释放刷新</div>
    <div class="refresh">正在刷新</div>
  </div>
  <div id="list"  class='demos-content-padded proListWrap'>


  </div>
  <div class="weui-loadmore" style="display: none">
    <i class="weui-loading"></i>
    <span class="weui-loadmore__tips">正在加载</span>
  </div>
 
  
</div>


<{include file="public/footer" /}>
<script>
  var cpage = 1;
  var st = 1;
  var category_id= bs_get_param('category_id');
  var sort = 'normal';
  var keyword = bs_get_param('keyword');
  if (keyword){
    $("#searchInput").val(keyword)
  }
  function load_data(){
    if (st==0){
      return ;
    }
    var keyword = $("#searchInput").val();
    bs_request("<{:url('/mall/goods/goods_list')}>",{page:cpage,keyword:keyword,category_id:category_id,sort:sort},function (res) {


      if (res.code==0 && res.data.goods.length>0) {

        for (var i = 0; i < res.data.goods.length; i++) {
          $("#list").append('<div class="pro-items">\n' +
                  '      <a href="<{:url(\'/mall/goods/detail\')}>?id='+res.data.goods[i].id+'" class="weui-media-box weui-media-box_appmsg">\n' +
                  '        <div class="weui-media-box__hd"><img class="weui-media-box__thumb" src="'+res.data.goods[i].thumb+'" alt=""></div>\n' +
                  '        <div class="weui-media-box__bd">\n' +
                  '          <h1 class="weui-media-box__desc">'+res.data.goods[i].title+'</h1>\n' +
                  '          <div class="wy-pro-pri">¥<em class="num font-15">'+res.data.goods[i].price+'</em></div>\n' +
                  '          <ul class="weui-media-box__info prolist-ul">\n' +
                  '            <li class="weui-media-box__info__meta"><em class="num">0</em>条评价</li>\n' +
                  '            <li class="weui-media-box__info__meta"><em class="num">100%</em>好评</li>\n' +
                  '          </ul>\n' +
                  '        </div>\n' +
                  '      </a>\n' +
                  '    </div>')
        }
      }else{
        st = 0;
      }
    });
  }

  load_data();


  function setSort(stype,obj){
    //SortAscCss,SortDescCss,NormalCss

    var nowSort = '';
    if (stype=='normal'){
        nowSort = 'normal';

        $(".sort-item").removeClass("SortAscCss SortDescCss");
        $(obj).addClass("NormalCss");
    }else if(stype=='price'){
      if (!$(obj).hasClass('SortAscCss')){
        nowSort = 'price_asc';
        $(".sort-item").removeClass("SortAscCss SortDescCss NormalCss");
        $(obj).removeClass('SortDescCss');
        $(obj).addClass('SortAscCss');
      }else {
        nowSort = 'price_desc';
        $(".sort-item").removeClass("SortAscCss SortDescCss NormalCss");
        $(obj).removeClass('SortAscCss');
        $(obj).addClass('SortDescCss');
      }

    }else if(stype=='sale'){

      if (!$(obj).hasClass('SortAscCss')){
        nowSort = 'sale_asc';
        $(".sort-item").removeClass("SortAscCss SortDescCss NormalCss");
        $(obj).removeClass('SortDescCss');
        $(obj).addClass('SortAscCss');
      }else {
        nowSort = 'sale_desc';
        $(".sort-item").removeClass("SortAscCss SortDescCss NormalCss");
        $(obj).removeClass('SortAscCss');
        $(obj).addClass('SortDescCss');
      }
    }
    if (sort==nowSort){
      return ;
    }
    sort = nowSort;
    cpage = 1;
    st =1;
    $("#list").empty();
    load_data();
  }

  $("#searchCancel").on('click',function () {
    $("#searchInput").val('')
    cpage = 1;
    st =1;
    $("#list").empty();
    load_data();
  });

  $(document.body).pullToRefresh().on("pull-to-refresh", function() {
    $("#list").empty();
    cpage = 1;

    setTimeout(function() {
      $("#time").text(new Date);
      $(document.body).pullToRefreshDone();
      load_data();
    }, 1000);
  });

  // 滚动加载
  var loading = false;
  $("#list").infinite().on("infinite", function() {
    $(".weui-loadmore").show();
    if(loading) return;
    loading = true;
    setTimeout(function() {
      cpage = cpage+1;
      load_data();
      loading = false;
      $(".weui-loadmore").hide();
    }, 1000);
  });
</script>
</body>
</html>
